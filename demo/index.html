<!DOCTYPE html>
<html lang="en">
<head>
    <title>One-viz Demo</title>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111827; /* Darker Slate Gray for the page background */
            color: #f9fafb;
            margin: 0;
            padding: 1em;
        }
        header { text-align: center; margin-bottom: 2em; }
        h1 { font-size: 2.5em; color: #f9fafb; }
        h2 { font-size: 1.8em; border-bottom: 1px solid #374151; padding-bottom: 0.5em; margin-top: 2em; }
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 2em;
        }
        .chart-wrapper {
            background-color: #1f2937; /* Match the chart background */
            border: 1px solid #374151; /* Slightly lighter border */
            border-radius: 8px;
            padding: 1.5em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .theme-controls {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1.5em;
            margin-bottom: 2em;
        }
        .theme-controls h3 { margin-top: 0; }
        .theme-controls .control-group { margin-bottom: 1em; }
        .theme-controls label { display: block; margin-bottom: 0.5em; font-weight: bold; }
        .theme-controls input, .theme-controls select {
            width: 100%;
            padding: 0.5em;
            background-color: #374151;
            color: #f9fafb;
            border: 1px solid #4b5563;
            border-radius: 4px;
            box-sizing: border-box;
        }
    .theme-controls .color-palette {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1em;
        }
    </style>
</head>
<body>

    <header>
        <h1>One-viz Component Demo</h1>
    </header>

    <div class="theme-controls">
        <h3>Dynamic Theme Controls</h3>
        <div class="control-group">
            <label for="chart-selector">Select Chart to Theme:</label>
            <select id="chart-selector">
                <option value="all">All Charts</option>
                <option value="bar-chart">Bar Chart</option>
                <option value="pie-chart">Pie Chart</option>
                <option value="line-chart">Line Chart</option>
                <option value="scatter-chart">Scatter Chart</option>
                <option value="heatmap-chart">Heatmap Chart</option>
                <option value="bubble-chart">Bubble Chart</option>
            </select>
        </div>
        <div class="control-group">
            <label for="bg-color-picker">Background Color:</label>
            <input type="color" id="bg-color-picker">
        </div>
        <div class="control-group">
            <label for="title-color-picker">Title Color:</label>
            <input type="color" id="title-color-picker">
        </div>
        <div class="control-group">
            <label for="axis-label-color-picker">Axis/Label Color:</label>
            <input type="color" id="axis-label-color-picker">
        </div>
        <hr>
        <label>Data Color Palette:</label>
        <div class="color-palette">
            <div class="control-group">
                <label for="color-1-picker">Color 1:</label>
                <input type="color" id="color-1-picker">
            </div>
            <div class="control-group">
                <label for="color-2-picker">Color 2:</label>
                <input type="color" id="color-2-picker">
            </div>
            <div class="control-group">
                <label for="color-3-picker">Color 3:</label>
                <input type="color" id="color-3-picker">
            </div>
            <div class="control-group">
                <label for="color-4-picker">Color 4:</label>
                <input type="color" id="color-4-picker">
            </div>
        </div>
        <hr>
        <div class="control-group">
            <label for="tooltip-format-input">Tooltip Format:</label>
            <input type="text" id="tooltip-format-input" placeholder="e.g., <b>{point.key}</b>: {point.y}">
        </div>
    </div>

    <div class="container">
        <div class="chart-wrapper"><oneviz-barchart id="bar-chart" x-field="month" y-field="revenue" title="Monthly Revenue"></oneviz-barchart></div>
        <div class="chart-wrapper"><oneviz-piechart id="pie-chart" x-field="source" y-field="users" title="Website Traffic Sources"></oneviz-piechart></div>
        <div class="chart-wrapper"><oneviz-linechart id="line-chart" x-field="month" y-field="profit" title="Monthly Profit"></oneviz-linechart></div>
        <div class="chart-wrapper"><oneviz-scatterchart id="scatter-chart" x-field="price" y-field="units_sold" title="Price vs. Units Sold"></oneviz-scatterchart></div>
        <div class="chart-wrapper"><oneviz-heatmap id="heatmap-chart" title="Sales per Employee per Day"></oneviz-heatmap></div>
        <div class="chart-wrapper"><oneviz-bubblechart id="bubble-chart" title="Market Analysis (Price vs. Sales vs. Market Share)" x-field="price" y-field="units_sold" z-field="market_share"></oneviz-bubblechart></div>
    </div>

    <h2>Event Log</h2>
    <div class="container">
        <pre id="event-log" style="background-color: #374151; color: #d1d5db; padding: 1em; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; height: 200px; overflow-y: auto;"></pre>
    </div>

    <script type="module">
        import(`/dist/one-viz.bundle.js?v=${Date.now()}`);

        const demoData = {
          sales: [
            { "month": "Jan", "revenue": 15000, "profit": 6000 },
            { "month": "Feb", "revenue": 18000, "profit": 7500 },
            { "month": "Mar", "revenue": 22000, "profit": 9000 },
            { "month": "Apr", "revenue": 25000, "profit": 10000 },
            { "month": "May", "revenue": 23000, "profit": 9500 }
          ],
          traffic: [ { "source": "Organic", "users": 2500 }, { "source": "Direct", "users": 1800 }, { "source": "Referral", "users": 1200 } ],
          product_stats: [ { "price": 10, "units_sold": 150 }, { "price": 15, "units_sold": 120 }, { "price": 20, "units_sold": 110 }, { "price": 25, "units_sold": 90 }, { "price": 30, "units_sold": 80 } ],
          heatmap_data: {
            xCategories: ['Alexander', 'Marie', 'Maximilian', 'Sophia', 'Lukas', 'Maria', 'Leon', 'Anna', 'Tim', 'Laura'],
            yCategories: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'],
            data: [
              [0, 0, 10], [0, 1, 19], [0, 2, 8], [0, 3, 24], [0, 4, 67], [1, 0, 92], [1, 1, 58], [1, 2, 78], [1, 3, 117], [1, 4, 48], [2, 0, 35], [2, 1, 15], [2, 2, 123], [2, 3, 64], [2, 4, 52], [3, 0, 72], [3, 1, 132], [3, 2, 114], [3, 3, 19], [3, 4, 16], [4, 0, 38], [4, 1, 5], [4, 2, 8], [4, 3, 117], [4, 4, 115], [5, 0, 88], [5, 1, 32], [5, 2, 12], [5, 3, 6], [5, 4, 120], [6, 0, 13], [6, 1, 44], [6, 2, 88], [6, 3, 98], [6, 4, 96], [7, 0, 31], [7, 1, 1], [7, 2, 82], [7, 3, 32], [7, 4, 30], [8, 0, 85], [8, 1, 97], [8, 2, 123], [8, 3, 64], [8, 4, 84], [9, 0, 47], [9, 1, 114], [9, 2, 31], [9, 3, 48], [9, 4, 91]
            ]
          },
          market_data: [
            { "price": 10, "units_sold": 150, "market_share": 25 },
            { "price": 15, "units_sold": 120, "market_share": 30 },
            { "price": 20, "units_sold": 110, "market_share": 22 },
            { "price": 25, "units_sold": 90, "market_share": 15 },
            { "price": 30, "units_sold": 80, "market_share": 8 }
          ]
        };

        const eventLog = document.getElementById('event-log');
        function logEvent(event) {
            const { type, detail } = event;
            const detailWithoutEvent = { ...detail, source: `[${detail.source.tagName}]` };
            eventLog.textContent = `Event: ${type}\n\n${JSON.stringify(detailWithoutEvent, null, 2)}\n\n` + eventLog.textContent;
        }

        const chartSelector = document.getElementById('chart-selector');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const titleColorPicker = document.getElementById('title-color-picker');
        const axisLabelColorPicker = document.getElementById('axis-label-color-picker');
        const tooltipFormatInput = document.getElementById('tooltip-format-input');
        const colorPickers = [
            document.getElementById('color-1-picker'),
            document.getElementById('color-2-picker'),
            document.getElementById('color-3-picker'),
            document.getElementById('color-4-picker'),
        ];

        const charts = {
            'bar-chart': document.getElementById('bar-chart'),
            'pie-chart': document.getElementById('pie-chart'),
            'line-chart': document.getElementById('line-chart'),
            'scatter-chart': document.getElementById('scatter-chart'),
            'heatmap-chart': document.getElementById('heatmap-chart'),
            'bubble-chart': document.getElementById('bubble-chart')
        };

        const defaultTheme = {
            '--oneviz-background-color': '#1f2937', // Dark Slate Gray
            '--oneviz-title-color': '#f9fafb', // Off-white
            '--oneviz-axis-label-color': '#d1d5db', // Light Gray
            '--oneviz-font-family': "'Inter', sans-serif",
            '--oneviz-color-1': '#38bdf8', // Sky Blue
            '--oneviz-color-2': '#818cf8', // Indigo
            '--oneviz-color-3': '#a78bfa', // Violet
            '--oneviz-color-4': '#f472b6', // Pink
        };

        // This state object is the single source of truth for themes.
        const chartThemes = {};

        function applyThemeFor(chartId, theme) {
            const chart = charts[chartId];
            if (!chart) return;

            chartThemes[chartId] = theme; // Update state
            Object.entries(theme).forEach(([prop, value]) => {
                chart.style.setProperty(prop, value);
            });
            chart.refreshChart();
        }

        function applyTooltipFormat(chartId, format) {
            const chart = charts[chartId];
            if (!chart) return;
            chart.setAttribute('tooltip-format', format);
        }

        function onControlsChange() {
            const selectedChartId = chartSelector.value;
            const chartIdsToUpdate = selectedChartId === 'all' ? Object.keys(charts) : [selectedChartId];

            const newTheme = {
                '--oneviz-background-color': bgColorPicker.value,
                '--oneviz-title-color': titleColorPicker.value,
                '--oneviz-axis-label-color': axisLabelColorPicker.value,
                '--oneviz-color-1': colorPickers[0].value,
                '--oneviz-color-2': colorPickers[1].value,
                '--oneviz-color-3': colorPickers[2].value,
                '--oneviz-color-4': colorPickers[3].value,
            };

            chartIdsToUpdate.forEach(id => applyThemeFor(id, newTheme));
            chartIdsToUpdate.forEach(id => applyTooltipFormat(id, tooltipFormatInput.value));
        }

        function onSelectorChange() {
            const selectedChartId = chartSelector.value;
            const theme = selectedChartId === 'all' ? defaultTheme : chartThemes[selectedChartId];

            bgColorPicker.value = theme['--oneviz-background-color'];
            titleColorPicker.value = theme['--oneviz-title-color'];
            axisLabelColorPicker.value = theme['--oneviz-axis-label-color'];
            colorPickers[0].value = theme['--oneviz-color-1'];
            colorPickers[1].value = theme['--oneviz-color-2'];
            colorPickers[2].value = theme['--oneviz-color-3'];
            colorPickers[3].value = theme['--oneviz-color-4'];

            const chart = charts[selectedChartId];
            tooltipFormatInput.value = chart ? chart.getAttribute('tooltip-format') || '' : '';
        }

        // --- Main Initialization ---
        async function main() {
            // Wait for all chart components to be defined
            await Promise.all(Object.values(charts).map(c => c ? customElements.whenDefined(c.localName) : Promise.resolve()));

            // Initialize themes and set data for each chart
            Object.entries(charts).forEach(([id, chart]) => {
                if (!chart) return;
                chartThemes[id] = { ...defaultTheme };
                Object.entries(chartThemes[id]).forEach(([prop, value]) => {
                    chart.style.setProperty(prop, value);
                });

                if (id === 'bar-chart' || id === 'line-chart') chart.data = demoData.sales;
                else if (id === 'pie-chart') chart.data = demoData.traffic;
                else if (id === 'scatter-chart') chart.data = demoData.product_stats;
                else if (id === 'heatmap-chart') {
                  chart.xCategories = demoData.heatmap_data.xCategories;
                  chart.yCategories = demoData.heatmap_data.yCategories;
                  chart.data = demoData.heatmap_data.data;
                } else if (id === 'bubble-chart') {
                  chart.data = demoData.market_data;
                }
            });

            // Set initial state of the controls
            onSelectorChange();

            // Wire up event listeners
            window.addEventListener('oneviz-filter-change', logEvent);
            chartSelector.addEventListener('change', onSelectorChange);
            bgColorPicker.addEventListener('input', onControlsChange);
            titleColorPicker.addEventListener('input', onControlsChange);
            axisLabelColorPicker.addEventListener('input', onControlsChange);
            colorPickers.forEach(picker => picker.addEventListener('input', onControlsChange));
            tooltipFormatInput.addEventListener('input', onControlsChange);
        }

        main();
    </script>
</body>
</html>